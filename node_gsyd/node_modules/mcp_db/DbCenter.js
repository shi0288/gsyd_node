var async = require('async');
var prop = require('mcp_config').prop;
var esdb = require('easy_db');
var Database = esdb.Database;
var Table = esdb.Table;
var Column = esdb.Column;


var esut = require("easy_util");
var log = esut.log;

var DbCenter = function(){
    var self = this;
};

DbCenter.prototype.init = function(cb)
{
    var self = this;
    esdb.log.setShowLog(true);
    async.waterfall([
        //the mysql
        function(cb){
            self._initMain(function(err){
                if(!err){
                    log.info('-----数据库初始化完成')
                }
                cb(err);
            });
        },
        //the mongodb
        function(cb){
            self._initMg(function(err){
                if(!err){
                    log.info('-----MongoDB初始化完成')
                }
                cb(err);
            });
        }
    ], function (err, result) {
        cb(err);
    });
};

DbCenter.prototype.check = function(cb)
{
    var self = this;
    async.waterfall([
        //check the mysql
        function(cb){
            self._checkMain(function(err){
                if(!err){
                    log.info('-----数据库检查项完成')
                }
                cb(err);
            });
        },
        //check the mongodb
        function(cb){
            self._checkMg(function(err){
                if(!err){
                    log.info('-----MongoDB检查项完成')
                }
                cb(err);
            });
        }
    ], function (err, result) {
        cb(err);
    });
};

DbCenter.prototype._initMain = function(cb)
{
    var self = this;
    var db = new Database(prop.main);

    //add tables
    var customer = new Table(db, "customer", [
        new Column(db, "id", "bigint", -1, false, undefined, true, true),
        new Column(db, "userId", "varchar", 10, false, undefined),
        new Column(db, "name", "varchar", 10, false, undefined),
        new Column(db, "st", "varchar", 32, false, undefined),
        new Column(db, "type", "bigint", -1, false, undefined),
        new Column(db, "createTime", "date", -1, false, undefined)
    ]);

    db.put(customer);
    self.main = db;
    self.main.init(cb);
};



DbCenter.prototype._initMg = function(cb)
{
    var self = this;
    var db = new Database(prop.mg);

    //add tables

    self.mg = db;
    self.mg.init(cb);
};


DbCenter.prototype._checkMain = function(cb)
{
    var self = this;
    cb(null);
};

DbCenter.prototype._checkMg = function(cb)
{
    var self = this;
    cb(null);
};








module.exports = new DbCenter();

