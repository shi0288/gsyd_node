/**
 * Created by shiqm on 16-4-11.
 */
'use strict';
var dc = require('mcp_db').dc;
var CronJob = require('cron').CronJob;
var async = require('async');
var esut = require('easy_util');
var log = esut.log;

var cons = require('mcp_constants');
var taskCons = cons.taskCons;
var loanStatus = cons.loanStatus;

var LoanTask = function () {
};


LoanTask.prototype.run = function () {
    var self = this;
    self.checkRaiseTime.start();
    log.info("定时任务处理已启动");
};

LoanTask.prototype.checkRaiseTime = new CronJob('*/10 * * * * *', function () {
    var task = dc.mg.get('task');
    task.findAndRemove({
        fireTime: {$lte: new Date().getTime(), $exists: true},
        type: taskCons['recheck']
    }, {}, [], function (err, data) {
        if (data == null) {
        } else {
            var loanTab = dc.main.get('loan');
            console.log(data.loan_id);
            loanTab.update({id: data.loan_id}, {$set: {status: loanStatus.recheck}}, [], function (err, rst) {
                if (err) {
                    log.error("出错:定时任务更改项目状态:"+data.loan_id);
                } else {
                    log.info("定时任务更改项目状态:"+data.loan_id);
                }
            })
        }
    });
},null, false);



var loanTask = new LoanTask();
module.exports = loanTask;