/**
 * Created by shiqm on 16-3-24.
 */
'use strict';

var dc = require('mcp_db').dc;

var esul = require('easy_util');
var digestUtil = esul.digestUtil;

var util = require('mcp_util');
var objectUtil = util.objectUtil;

var async = require('async');

var UserService = function () {
};

UserService.prototype.getUserList = function (fields, cb) {
    console.log("-----------------"+fields);
    var conn = dc.main.getConn();
    var sql = "SELECT a.id,a.username,a.realname,a.sex,a.mobile_number,b.username referrerUsername,b.realname referrerRealname, b.mobile_number referrerMobileNumber,b.id_card,a.register_time,case (select COUNT(*) from invest where user_id=a.id and status='complete') when '0' then '未投资' else '已投资' end  as invset_status from user a left join user b  on a.referrer=b.id ";
   if (fields == null || fields == undefined) {
       conn.execute(sql, [], function (err, data) {
           cb(err, data);
       })
        return;
    }else{
       if(fields.indexOf("role")){
           sql = "SELECT " +
           "	a.id, " +
           "	a.username, " +
           "	a.realname, " +
           "	a.sex, " +
           "	a.mobile_number, " +
           "	b.username referrerUsername, " +
           "	b.realname referrerRealname, " +
           "	b.mobile_number referrerMobileNumber, " +
           "	b.id_card, " +
           "	a.register_time, " +
           "	CASE ( " +
           "		SELECT " +
           "			COUNT(*) " +
           "		FROM " +
           "			invest " +
           "		WHERE " +
           "			user_id = a.id " +
           "		AND STATUS = 'complete' " +
           "	) " +
           "WHEN '0' THEN " +
           "	'未投资' " +
           "ELSE " +
           "	'已投资' " +
           "END AS invset_status " +
           "FROM " +
           "	USER a " +
           "LEFT JOIN USER b ON a.referrer = b.id " +
           "LEFT JOIN user_role c ON a.id = c.user_id " +
           "WHERE 1=1"

           fields = JSON.parse(fields);
           for(var i in fields){
               if(i=="id"){
                   sql += " and a.id = '"+fields[i]+"'";
               }else if(i=="username"){
                   sql += " and a.username = '"+fields[i]+"'";
               }else if(i=="start_register_time"){
                   sql += " and a.register >= '"+fields[i]+"'";
               }else if(i=="end_register_time"){
                   sql += " and a.register <= '"+fields[i]+"'";
               }else if(i=="referrerUsername"){
                   sql += " and a.referrer = '"+fields[i]+"'";
               }else if(i=="role"){
                   sql += " and c.role_id = '"+fields[i]+"'";
               }
           }
           console.log("---------------------------------"+sql);
           conn.execute(sql, [], function (err, data) {
               cb(err, data);
           })
       }else{

           sql ="SELECT " +
           "	a.id, " +
           "	a.username, " +
           "	a.realname, " +
           "	a.sex, " +
           "	a.mobile_number, " +
           "	b.username referrerUsername, " +
           "	b.realname referrerRealname, " +
           "	b.mobile_number referrerMobileNumber, " +
           "	b.id_card, " +
           "	a.register_time, " +
           "	CASE ( " +
           "		SELECT " +
           "			COUNT(*) " +
           "		FROM " +
           "			invest " +
           "		WHERE " +
           "			user_id = a.id " +
           "		AND STATUS = 'complete' " +
           "	) " +
           "WHEN '0' THEN " +
           "	'未投资' " +
           "ELSE " +
           "	'已投资' " +
           "END AS invset_status " +
           "FROM " +
           "	USER a " +
           "LEFT JOIN USER b ON a.referrer = b.id " +
           "WHERE 1=1";
           fields = JSON.parse(fields);
           console.log(fields);
           for (var i in fields) {
               if(fields[i]!=""){
                   if(i=="id"){
                       sql += " and a.id = '"+fields[i]+"'";
                   }else if(i=="username"){
                       sql += " and a.username = '"+fields[i]+"'";
                   }else if(i=="start_register_time"){
                       sql += " and a.register >= '"+fields[i]+"'";
                   }else if(i=="end_register_time"){
                       sql += " and a.register <= '"+fields[i]+"'";
                   }else if(i=="referrerUsername"){
                       sql += " and a.referrer = '"+fields[i]+"'";
                   }
               }
           }
           console.log("---------------------------------"+sql);
           conn.execute(sql, [], function (err, data) {
               cb(err, data);
           })
       }
   }

};


module.exports = new UserService();