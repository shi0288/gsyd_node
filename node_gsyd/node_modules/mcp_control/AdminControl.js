var async = require('async');
var dc = require('mcp_db').dc;
var esut = require('easy_util');
var log = esut.log;
var digestUtil = esut.digestUtil;

var cons = require('mcp_constants');
var userType = cons.userType;

var config = require('mcp_config');
var ec = config.ec;
var prop = config.prop;


var AdminControl = function () {
    var self = this;
    self.cmd = {'AD01': 1};
    self.cmdArray = [
        {},
        {id: 1, code: 'AD01', fromType: prop.digestFromType.DB, des: "管理员登陆"}
    ];
};

AdminControl.prototype.handle = function (headNode, bodyStr, userCb) {
    var self = this;
    async.waterfall([
        //是否是支持的cmd
        function (cb) {
            var cmd = self.cmd[headNode.cmd];
            if (cmd == undefined) {
                cb(ec.E2060);
            }
            else {
                cb(null);
            }
        },
        //校验头的用户类型是否合法
        function (cb) {
            var userTypeId = userType[headNode.userType];
            if (userTypeId == undefined) {
                cb(ec.E9005);
            }
            else {
                cb(null, userTypeId);
            }
        },
        //获得密钥
        function (userTypeId, cb) {
            var cmd = self.cmdArray[self.cmd[headNode.cmd]];
            //digestSer.getKey({fromType: cmd.fromType, userId: headNode.userId, userType: userTypeId},
            //    function (err, key) {
            //
            //    });
            cb(null);
        },
        //先解密
        function (key, cb) {
            log.info(key);
            var decodedBodyStr = digestUtil.check(headNode, key, bodyStr);
            try {
                var bodyNode = JSON.parse(decodedBodyStr);
                headNode.key = key;
                cb(null, bodyNode);
            }
            catch (err) {
                cb(ec.E9003);
            }
        },
        //check the param
        function (bodyNode, cb) {
            var method = 'check' + headNode.cmd;
            self[method](null, headNode, bodyNode, function (err) {
                cb(err, bodyNode);
            });
        },
        //业务处理
        function (bodyNode, cb) {
            var cmd = 'handle' + headNode.cmd;
            self[cmd](null, headNode, bodyNode, cb);
        }
    ], function (err, bodyNode) {
        userCb(err, bodyNode);
    });
};


AdminControl.prototype.checkAD01 = function (user, headNode, bodyNode, cb) {
    cb(null);
};




/**
 * @param user
 * @param headNode
 * @param bodyNode
 * @param cb
 */
AdminControl.prototype.handleAD01 = function (user, headNode, bodyNode, cb) {
    cb(ec.E0003);

};


var adminControl = new AdminControl();
module.exports = adminControl;